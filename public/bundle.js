!function(e){var t={};function r(s){if(t[s])return t[s].exports;var a=t[s]={i:s,l:!1,exports:{}};return e[s].call(a.exports,a,a.exports,r),a.l=!0,a.exports}r.m=e,r.c=t,r.d=function(e,t,s){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(r.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)r.d(s,a,function(t){return e[t]}.bind(null,a));return s},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=0)}([function(e,t,r){"use strict";r.r(t);const s={MAGIC:4278259967,PACKET_FIELD_SIZE_MAGIC:4,PACKET_FIELD_SIZE_TYPE:2,PACKET_FIELD_SIZE_DATA_LENGTH:4,packetTypes:{EXIT_BOOTLOADER:1,READY_FOR_DOWNLOAD_REQUEST:2,READY_FOR_DOWNLOAD_RESPONSE:3,FIRMWARE_FRAGMENT_REQUEST:4,FIRMWARE_FRAGMENT_RESPONSE:5,PING:6,FIRMWARE_UPDATE_DONE:7},WS_ENDPOINT:"bootloader/ws",HTTP_ENDPOINT:"/bootloader"},a={ERROR_SHOW_INTERVAL:5e3},n={USE_WEBSOCKET:!1},i="1.0.4";const o="GET",l="POST",u=200,c=299;class h extends class{constructor({host:e=location.host,endpoint:t}){this._host=e,this._endpoint=t,this._wsIptr=null,this._handleWsOpen=this._handleWsOpen.bind(this),this._handleWsMessage=this._handleWsMessage.bind(this),this._handleWsCloseOrError=this._handleWsCloseOrError.bind(this),this._textMessageReceivedCallback=null,this._binaryDataReceivedCallback=null,this._terminated=!1}setTextMessageReceivedCallback(e){this._textMessageReceivedCallback=e}setBinaryDataReceivedCallback(e){this._binaryDataReceivedCallback=e}_handleWsOpen(){}_handleWsClosed(){}_handleWsMessage(e){"string"!=typeof e.data?this._binaryDataReceivedCallback&&this._binaryDataReceivedCallback(e.data):this._textMessageReceivedCallback&&this._textMessageReceivedCallback(e.data)}_handleWsCloseOrError(){this._handleWsClosed(),this.open()}open(){if(!(this._wsIptr&&this._wsIptr.readyState!==WebSocket.CLOSED||this._terminated))try{this._wsIptr=new WebSocket(`ws://${this._host}${this._endpoint}`),this._wsIptr.binaryType="arraybuffer",this._wsIptr.onopen=this._handleWsOpen,this._wsIptr.onmessage=this._handleWsMessage,this._wsIptr.onclose=this._handleWsCloseOrError,this._wsIptr.onerror=this._handleWsCloseOrError}catch(e){setTimeout(this._handleWsCloseOrError,1e3)}}close(){this._wsIptr&&(this._wsIptr.onopen=null,this._wsIptr.onmessage=null,this._wsIptr.onerror=null,this._wsIptr.onclose=null,this._wsIptr.close(),this._wsIptr=null,this._terminated=!0)}sendArray(e=[]){if(!this._wsIptr)return this.open(),!1;if(this._wsIptr.readyState===WebSocket.CLOSING)return this._handleWsCloseOrError(),!1;if(this._wsIptr.readyState===WebSocket.CLOSED)return this.open(),this._handleWsCloseOrError(),!1;if(e instanceof ArrayBuffer)return this._wsIptr.send(e),!0;const t=new ArrayBuffer(e.length),r=new DataView(t);e.forEach((e,t)=>{r.setUint8(t,e)});try{return this._wsIptr.send(t),!0}catch(e){this._handleWsCloseOrError()}return!1}}{constructor({wsConnectedCallback:e,updateStatusCallback:t}={}){super({endpoint:s.WS_ENDPOINT}),this._endpoint=s.HTTP_ENDPOINT,this.ping=this.ping.bind(this),this._ping=this._ping.bind(this),this._sendWsReadyForDownloadPacket=this._sendWsReadyForDownloadPacket.bind(this),this._handleWsBinaryData=this._handleWsBinaryData.bind(this),this._initialized=!1,this._webSocketMode=!1,this._autoPingTimerId=null,this._firmwareArrayBuffer=null,this._wsConnectedCallback=e,this._updateStatusCallback=t,this._wsBurnTimer=null,this._wsBurnDone=!1,this._wsBurned=0}init(){this._initialized||(this._initialized=!0,n.USE_WEBSOCKET&&(this.setBinaryDataReceivedCallback(this._handleWsBinaryData),this.open()))}_handleWsOpen(){this._webSocketMode=!0,this._wsConnectedCallback&&this._wsConnectedCallback(!0)}_handleWsClosed(){this._webSocketMode=!1,this._wsConnectedCallback&&this._wsConnectedCallback(!1)}_sendWsReadyForDownloadPacket(){const e=null===this._firmwareArrayBuffer?[0,0,0,0]:[255&this._firmwareArrayBuffer.byteLength,this._firmwareArrayBuffer.byteLength>>8&255,this._firmwareArrayBuffer.byteLength>>16&255,this._firmwareArrayBuffer.byteLength>>24&255];return this.sendArray(this._createWsCommand(s.packetTypes.READY_FOR_DOWNLOAD_RESPONSE,e))}_handleFirmwareSegmentRequest(e){if(null===this._firmwareArrayBuffer&&this._sendWsReadyForDownloadPacket(),e.data.length<6)return;let t=0,r=e.data[t++]|e.data[t++]<<8|e.data[t++]<<16|e.data[t++]<<24,a=e.data[t++]|e.data[t++]<<8;if(r<this._firmwareArrayBuffer){const e=[];for(;r<this._firmwareArrayBuffer.byteLength&&a--;)e.push(this._firmwareArrayBuffer.getUint8(r++));this.sendArray(this._createWsCommand(s.packetTypes.FIRMWARE_FRAGMENT_RESPONSE,e)),this._wsBurned=r}}sendArray(e=[]){n.USE_WEBSOCKET&&super.sendArray(e)}_handleWsBinaryData(e){this._webSocketMode=!0;const t=this._parseWebSocketInputPacket(e);if(t)switch(t.type){case s.packetTypes.PING:this.ping();break;case s.packetTypes.READY_FOR_DOWNLOAD_REQUEST:this._sendWsReadyForDownloadPacket();break;case s.packetTypes.FIRMWARE_FRAGMENT_REQUEST:this._handleFirmwareSegmentRequest(t);break;case s.packetTypes.FIRMWARE_UPDATE_DONE:this._wsBurnDone=!0}}_parseWebSocketInputPacket(e){const t=new DataView(e),r=s.PACKET_FIELD_SIZE_MAGIC+s.PACKET_FIELD_SIZE_TYPE+s.PACKET_FIELD_SIZE_DATA_LENGTH;if(e.byteLength<r)return null;const a={magic:t.getUint32(0,!0),type:t.getUint32(s.PACKET_FIELD_SIZE_MAGIC,!0),dataLength:t.getUint32(s.PACKET_FIELD_SIZE_MAGIC+s.PACKET_FIELD_SIZE_TYPE,!0)};if(a.magic!==s.MAGIC)return null;if(a.dataLength!==e.byteLength-r)return null;a.data=[];for(let e=0;e<a.dataLength;e++)a.data.push(t.getUint8(r+e));return a}_insertInDataView(e,t,r,s){switch(s){case 1:e.setUint8(t,r);break;case 2:e.setUint16(t,r,!0);break;case 4:e.setUint32(t,r,!0);break;default:return t}return t+s}_createWsCommand(e,...t){const r=new ArrayBuffer(s.PACKET_FIELD_SIZE_MAGIC+s.PACKET_FIELD_SIZE_TYPE+s.PACKET_FIELD_SIZE_DATA_LENGTH+t.length),a=new DataView(r);let n=this._insertInDataView(a,0,s.MAGIC,s.PACKET_FIELD_SIZE_MAGIC);return n=this._insertInDataView(a,n,e,s.PACKET_FIELD_SIZE_TYPE),n=this._insertInDataView(a,n,t?t.length:0,s.PACKET_FIELD_SIZE_DATA_LENGTH),t.forEach(e=>a.setUint8(n++,e)),r}_request({url:e,method:t=o,body:r=null,headers:s=new Headers,commitProgress:a=!1}){return new Promise((n,i)=>{let o=new XMLHttpRequest;o.open(t,`${this._endpoint}/${e}`);const l=s.entries();let u=null;for(;!1===(u=l.next()).done;)o.setRequestHeader(u.value[0],u.value[1]);o.send(r),o.onload=()=>{a&&this._updateStatusCallback&&this._updateStatusCallback({bytesOverall:this._firmwareArrayBuffer.byteLength,bytesBurned:this._firmwareArrayBuffer.byteLength,percent:100,finished:!0}),n(o)},o.onerror=()=>{i("Error while performing XMLHttpRequest")},a&&this._updateStatusCallback&&(o.upload.onprogress=function(e){const t={bytesOverall:e.total,bytesBurned:e.loaded,percent:Math.round(100*e.loaded/e.total),finished:!1};this._updateStatusCallback(t)})}).then(h.checkStatus)}_makeRequestWithDataResponse({url:e,method:t=o,body:r=null,headers:s=new Headers}){return this._request({url:e,method:t,body:r,headers:s}).then(e=>"application/json"===e.headers.get("Content-Type")?h.toJSON(e):h.toBLOB(e)).catch(h.catchError)}_makeRequestWithoutDataResponse({url:e,method:t=o,body:r=null,headers:s=new Headers,commitProgress:a=!1}){return this._request({url:e,method:t,body:r,headers:s,commitProgress:a}).catch(h.catchError)}static checkStatus(e){if(e.status<u||e.status>c)throw new Error(`${e.status}: ${e.statusText}`);return e.response}static toJSON(e){return e.json()}static toBLOB(e){return e.blob().then(e=>e)}static catchError(e){throw e}setAutopingMode(e,t=1e3){null!==this._autoPingTimerId&&clearInterval(this._autoPingTimerId),e&&(this._autoPingTimerId=setInterval(this._ping,t<1e3?1e3:t))}_ping(){this.ping().then(()=>{}).catch(()=>{})}ping(){return this._firmwareArrayBuffer?Promise.reject():this._webSocketMode?new Promise((e,t)=>{this.sendArray(this._createWsCommand(s.packetTypes.PING))&&e(),t("web socket transmit error")}):this._makeRequestWithoutDataResponse({url:"ping",method:o}).then(e=>(this.close(),Promise.resolve(e)))}exitBootloader(){return this._webSocketMode?new Promise((e,t)=>{this.sendArray(this._createWsCommand(s.packetTypes.EXIT_BOOTLOADER))&&e(),t("web socket transmit error")}):this._makeRequestWithoutDataResponse({url:"exit",method:o})}_wsBurn(){return new Promise((e,t)=>{this._wsBurnTimer=setInterval(()=>{if(this._wsBurnDone)this._updateStatusCallback({bytesOverall:this._firmwareArrayBuffer.byteLength,bytesBurned:this._firmwareArrayBuffer.byteLength,percent:100,finished:!0}),clearInterval(this._wsBurnTimer),e();else if(this._updateStatusCallback){const e={bytesOverall:this._firmwareArrayBuffer.byteLength,bytesBurned:this._wsBurned,percent:Math.round(100*this._wsBurned/this._firmwareArrayBuffer.byteLength),finished:!1};this._updateStatusCallback(e)}this._sendWsReadyForDownloadPacket()||t()},100)})}isBurning(){return null!==this._firmwareArrayBuffer}burn(e){if(!e||this._firmwareArrayBuffer)return Promise.reject("burning already started");if(this._firmwareArrayBuffer=e,this._webSocketMode)return this._wsBurn();const t=new Headers;return t.set("Content-Type","application/octet-stream"),this._makeRequestWithoutDataResponse({url:"burn",method:l,headers:t,body:e,commitProgress:!0}).catch(e=>{throw this._firmwareArrayBuffer=null,e})}clearParams(e){if(this._webSocketMode)return null;const t=new Headers;return t.set("Content-Type","application/octet-stream"),this._makeRequestWithoutDataResponse({url:"erase-params",method:l,headers:t,body:e}).then(e=>(this.close(),Promise.resolve(e)))}}const d={error:document.querySelector(".error"),errorContent:document.querySelector(".error-content"),message:document.querySelector(".message"),messageContent:document.querySelector(".message-content"),appWrapper:document.querySelector(".app-wrapper"),webSocketIndicator:document.querySelector(".header-web-socket-inidicator"),exitBootloaderCheckbox:document.querySelector("#exit-boot"),exitBootloaderYesButton:document.querySelector("#exit-boot-yes"),exitBootloaderCancelButton:document.querySelector("#exit-boot-cancel"),chooseFirmwareButton:document.querySelector("#choose-firmware"),chosenFilenameSpan:document.querySelector(".main-choose-firmware-chosen-file"),chooseFirmwareDialogButton:document.querySelector("#file-input"),burnButton:document.querySelector("#burn"),burnStatusSpan:document.querySelector(".main-burn-status"),burnStatusProgressBar:document.querySelector(".main-burn-progress-bar"),headerTitle:document.querySelector(".header-title"),hiddenFuncs:document.querySelector(".hidden-funcs"),hiddenFuncsClose:document.querySelector("#hidden-funcs-close"),clearParamsPassword:document.querySelector("#clear-params-password"),clearParamsButton:document.querySelector("#clear-params-confirm")};let _=null;const p=function(e){const t=e;let r=null;return{show:e=>{t.querySelector("div").textContent=e,t.style.maxHeight="100%",t.style.opacity=1,t.querySelector("div").style.transform="translateX(0)",r&&(clearTimeout(r),r=null),r=setTimeout(()=>{clearTimeout(r),t.style.maxHeight=0,t.style.opacity=0,t.querySelector("div").style.transform="translateX(-100vw)",r=null,d.burnButton.disabled=null===_,document.querySelector("#burn-anime").style.display="none"},a.ERROR_SHOW_INTERVAL)}}},m=new p(d.error),y=new p(d.message),b=new h({wsConnectedCallback:e=>{d.webSocketIndicator.style.opacity=e?"0.7":"0"},updateStatusCallback:e=>{d.burnStatusSpan.textContent=e.percent+"%",d.burnStatusProgressBar.style.width=e.percent+"%",e.finished&&(d.burnStatusSpan.textContent="",d.burnStatusProgressBar.style.width="0")}});d.appWrapper.classList.remove("vertical-hided"),d.exitBootloaderCancelButton.addEventListener("click",()=>{d.exitBootloaderCheckbox.checked=!1}),d.exitBootloaderYesButton.addEventListener("click",()=>{b.exitBootloader().then(()=>{}).catch(e=>{m.show(e)})}),d.chooseFirmwareButton.addEventListener("click",()=>{_=null,d.burnButton.disabled=!0,d.chosenFilenameSpan.textContent="",d.chooseFirmwareDialogButton.value="",d.chooseFirmwareDialogButton.click()}),d.chooseFirmwareDialogButton.addEventListener("change",e=>{const t=e.target.files[0];d.chosenFilenameSpan.textContent=t.name;const r=new FileReader;r.readAsArrayBuffer(t),r.onload=e=>{_=e.target.result,d.burnButton.disabled=!1}}),d.burnButton.addEventListener("click",()=>{d.burnButton.disabled||b.isBurning()||(d.burnButton.disabled=!0,document.querySelector("#burn-anime").style.display="flex",b.burn(_).then(()=>{y.show("BURN DONE!")}).catch(e=>{m.show(e)}))}),d.headerTitle.setAttribute("version",i),(()=>{let e=0,t=0;d.headerTitle.addEventListener("click",()=>{e-Date.now()<100?(t++,t>=5&&(d.hiddenFuncs.style.transform="translateX(0)")):t=0,e=Date.now()}),d.hiddenFuncsClose.addEventListener("click",()=>{d.hiddenFuncs.style.transform="translateX(-100%)",t=0}),d.clearParamsButton.addEventListener("click",()=>{b.clearParams((new TextEncoder).encode(d.clearParamsPassword.value)).then(()=>{y.show("Params erased!")}).catch(e=>{m.show(e)})})})(),b.init(),b.setAutopingMode(!0,5e3)}]);
//# sourceMappingURL=bundle.js.map