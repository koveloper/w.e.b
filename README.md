# w.e.b
Web Embedded Bootloader (W.E.B)

---

Проект применяется совместно с загрузчиком встроенного ПО. Осуществляет загрузку выбранного пользователем **BIN** файла в загрузчик с помощью **POST** запроса или подключения по **WebSocket**.

## 1. Обновление с помощью AJAX

Данный режим является режимом по умолчанию. WEB интерфейс выходит из режима если произошло подключение по **WebSocket** к серверу загрузчика. 

1) В режиме **AJAX** WEB интерфейс осуществляет постоянные **PING** запросы с периодом 5 секунд. Параметры  **PING** запросов:
   - метод запроса: **GET**;
   - URL запросов: **http://<server.host>/bootloader/ping**.
2) При выборе пользователем файла прошивки и нажатии на кнопку **BURN** WEB интерфейс осуществляет запрос с параметрами:
   - метод запроса: **POST**;
   - **Content-Type**: *application/octet-stream*;
   - URL запроса: **http://<server.host>/bootloader/burn**.    
*По получении ответа на запрос обновления прошивки производится отображение сообщения об успехе или об ошибке.*

3) При нажатии пользователем на кнопку **EXIT BOOTLOADER** WEB интерфейс высылает запрос с параметрами:
   - метод запроса: **GET**;
   - URL запроса: **http://<server.host>/bootloader/exit**.




## 2. Обновление с помощью WebSocket

WEB интерфейс переходит в данный режим обновления в случае успешного подключения по протоколу **WebSocket** по URL  **http://<server.host>/bootloader/ws**. В этом случае соединение протоколируется пакетами, структура которых представлена в таблице.

| MAGIC<br>4 байта | PacketType<br>2 байта | DataLength<br>4 байта | Data<br>DataLength байт |
|:---:|:---:|:---:|:---:|
|**0xFF0110FF**|**VAR**|**VAR**|[array of bytes]|

Алгоритм работы в данном режиме следующий:

1) WEB интерфейс осуществляет постоянные **PING** запросы с периодом 5 секунд. Формат запроса представлен в таблице. Порядок байт в полях сообщения - **LSB**.
   
| MAGIC<br>4 байта | PacketType<br>2 байта | DataLength<br>4 байта |
|:---:|:---:|:---:|
|**0xFF0110FF**|**0x0006**|**0**|

2) При получении запроса с **PacketType=0x0002** или при выборе пользователем файла прошивки и нажатия на кнопку **BURN** WEB интерфейс однократно высылает пакет готовности с размером файла прошивки. Формат команды представлен в таблице. Нулевое значение поля **DataLength** сигнализирует о неготовности интерфейса выдавать фрагменты прошивки. Порядок байт в полях сообщения - **LSB**.
   
| MAGIC<br>4 байта | PacketType<br>2 байта | DataLength<br>4 байта | FirmwareFileLength<br>4 байта |
|:---:|:---:|:---:|:---:|
|**0xFF0110FF**|**0x0003**|**4**|**VAR**|

3) Запрос сегмента файла прошивки осущетвляется пакетом от сервера со структурой представленной в таблице. Порядок байт в полях сообщения - **LSB**. В ответ на запрос WEB интерфейс отправит пакет с фрагментом (п.4) или пакет готовности (если прошивка не выбрана) с нулевой длиной.
   
| MAGIC<br>4 байта | PacketType<br>2 байта | DataLength<br>4 байта | FirmwareFileOffset<br>4 байта | FirmwareFragmentSize<br>2 байта |
|:---:|:---:|:---:|:---:|:---:|
|**0xFF0110FF**|**0x0004**|**6**|**VAR**|**VAR**|

4) Пакет с фрагментом файла прошивки. Порядок байт в полях сообщения - **LSB**.
   
| MAGIC<br>4 байта | PacketType<br>2 байта | DataLength<br>4 байта | FirmwareFileFragment<br>DataLength байт |
|:---:|:---:|:---:|:---:|
|**0xFF0110FF**|**0x0005**|**VAR**|[array of bytes]|

5) По окончании загрузки файла прошивки сервер высылает сообщение окончания загрузки. Формат представлен в таблице. Порядок байт в полях сообщения - **LSB**.

| MAGIC<br>4 байта | PacketType<br>2 байта | DataLength<br>4 байта |
|:---:|:---:|:---:|
|**0xFF0110FF**|**0x0007**|**0**|

6) При нажатии пользователем на кнопку **EXIT BOOTLOADER**WEB интерфейс высылает пакет, формат которого представлен в таблице. Порядок байт в полях сообщения - **LSB**.

| MAGIC<br>4 байта | PacketType<br>2 байта | DataLength<br>4 байта |
|:---:|:---:|:---:|
|**0xFF0110FF**|**0x0001**|**0**|